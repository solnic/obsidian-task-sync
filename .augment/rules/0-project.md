---
type: "always_apply"
---

# Current Project Context

Project: Obsidian Task Sync
Status: UNRELEASED

# READ THIS BEFORE DOING ANYTHING!

The project is in a transition phase moving from an Obsidian plugin to a Svelte app that has Obsidian support as an extension. Previous code was moved to `old-stuff` and should be used as a reference when re-introducing functionality within the new architecture.

# COMMANDS FOR RUNNING TESTS

- `npm test` to run all tests
- `npm run test:e2e` to run all `e2e` tests
- `npm run test:e2e:failed` to run e2e tests that previously failed
- `npm run test:e2e -- -g "pattern"` to run all `e2e` tests matching pattern


# ðŸš¨ IMPORTANT INFORMATION ABOUT E2E TESTS ðŸš¨

- The project is in transition phase from `vitest` with `playwright` to just `playwright` - all new e2e tests from now on must be implemented in `playwright` only
- All existing `vitest` e2e tests will be migrated to `playwright` gradually

# ðŸš¨ IMPLEMENTATION RULES - NEVER VIOLATE ðŸš¨

- There is a lot of very defensive code in this code base with complex error try/catch logic and awful fallbacks like `foo.?bar || 0` - such code is bad and you MUST NOT follow such patterns when writing new code or changing existing code.

# ðŸš¨ TESTING RULES - NEVER VIOLATE ðŸš¨

- `e2e` tests are the most important tests in this project as they test real interactions with the Obsidian API and the UI
- DO NOT write unit tests for anything other than simple low-level utilities where UI is not involved, everything else MUST BE COVERED BY E2E TESTS

# ðŸš¨ UNIT TESTING RULES - NEVER VIOLATE ðŸš¨

- Do not mock Obsidian APIs - any feature that relies on Obsidian APIs must be tested in e2e tests

# ðŸš¨ E2E TESTING RULES - NEVER VIOLATE ðŸš¨

- Do not use fixed timeouts in tests - instead use smart-waiting strategy. Implement helpers for smart-waiting if necessary.
- You MUST ALWAYS see what test helpers are available and AVOID complex code in test scenarios
- E2E tests use Playwright with Electron - the setup automatically handles xvfb on Linux via `xvfb-maybe`
- **DOCKER ENVIRONMENT**: You are working in a Docker container - Playwright trace viewer and UI tools DO NOT WORK
- **NEVER run**: `npx playwright show-trace`, `npx playwright show-report`, or any interactive Playwright UI commands
- **ALWAYS analyze artifacts**: Check `tests/e2e/debug/` for screenshots, traces, and logs

# Running E2E Tests

## Basic Commands

- `npm test` - Run all tests (unit + e2e)
- `npm run test:e2e` - Run all e2e tests
- `npm run test:e2e:failed` - Re-run only tests that failed in the previous run
- `npm run test:e2e -- --grep "test name"` - Run specific test(s) matching pattern
- `npm run test:e2e -- --headed` - Run tests with visible browser window (not headless)
- `npm run test:e2e -- --debug` - Run tests in debug mode with Playwright Inspector

## Running Specific Tests

```bash
# Run a specific test file
npm run test:e2e tests/e2e/specs/playwright/app.e2e.ts

# Run tests matching a pattern
npm run test:e2e -- --grep "should create task"

# Run tests in a specific project
npm run test:e2e -- --project=electron
```

# Debugging E2E Tests in Docker

## Debug Artifacts Location

All debug artifacts are stored in `tests/e2e/debug/`:

```
tests/e2e/debug/
â”œâ”€â”€ test-results/           # Playwright test results
â”‚   â””â”€â”€ [test-name]/
â”‚       â”œâ”€â”€ trace.zip       # Playwright trace (analyze programmatically)
â”‚       â”œâ”€â”€ video.webm      # Video recording of test
â”‚       â””â”€â”€ screenshots/    # Screenshots on failure
â””â”€â”€ [test-dir]/            # Test-specific debug artifacts
    â”œâ”€â”€ vault-snapshot/    # Vault state at time of failure
    â”œâ”€â”€ console-logs.txt   # Console output from Obsidian
    â””â”€â”€ settings.json      # Plugin settings at time of failure
```

## Analyzing Debug Artifacts (Docker-Compatible Methods)

### 1. Check Artifacts Directory
```bash
ls -la tests/e2e/debug/test-results/
ls -la tests/e2e/debug/
```

### 2. View Screenshots
```bash
# Screenshots are saved on failure
ls tests/e2e/debug/test-results/*/screenshots/
```

### 3. Read Console Logs
```bash
cat tests/e2e/debug/test-results/*/console-logs.txt
grep -i "error" tests/e2e/debug/test-results/*/console-logs.txt
```

### 4. Analyze Trace Programmatically
```javascript
// If needed, extract trace data programmatically
const AdmZip = require('adm-zip');
const zip = new AdmZip('tests/e2e/debug/test-results/[test]/trace.zip');
const trace = JSON.parse(zip.readAsText('trace.json'));
console.log('Failed action:', trace.actions.find(a => a.error));
```

## UI and front-end

- `styles.css` is generated by the CSS build process. To change styles you must only edit CSS in `src/styles`
- DO NOT add inline styles to Svelte components, instead add them to appropriate file in `src/styles`